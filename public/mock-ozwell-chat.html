<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mock Ozwell Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { box-sizing: border-box; }
        html, body { 
            margin: 0; 
            padding: 0; 
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        .container {
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
        }
        .chat-header { 
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
            flex-shrink: 0;
        }
        .chat-container { 
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            width: 100%;
            min-height: 0; /* Important for flex child scrolling */
        }
        .footer-buttons {
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
            padding: 16px;
            width: 100%;
            flex-shrink: 0;
        }
        .message-bubble { 
            max-width: 85%; 
            margin-bottom: 12px;
        }
        .user-message { 
            background: #3b82f6; 
            color: white; 
            margin-left: auto; 
            text-align: right; 
        }
        .ai-message { 
            background: #f1f5f9; 
            color: #334155; 
            margin-right: auto; 
        }
        .suggestion-button {
            background: #e2e8f0;
            border: 1px solid #cbd5e1;
            margin: 4px 2px;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            display: inline-block;
            font-size: 14px;
            width: auto;
        }
        .suggestion-button:hover {
            background: #3b82f6;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Chat Header -->
        <div class="chat-header">
            <h3 class="font-semibold text-gray-800">AI Writing Assistant</h3>
            <p class="text-sm text-gray-600" id="context-info">Ready to help improve your text</p>
        </div>

        <!-- Chat Messages -->
        <div id="chat-container" class="chat-container space-y-3">
            <div class="message-bubble ai-message p-3 rounded-lg">
                <p class="text-sm">Hi! I'm here to help you improve your text. What would you like to work on?</p>
            </div>
        </div>

        <!-- Action Buttons Footer -->
        <div class="footer-buttons">
            <div class="flex gap-2 justify-end">
                <button id="cancel-btn" class="px-4 py-2 text-gray-600 border border-gray-300 rounded hover:bg-gray-100">
                    Cancel
                </button>
                <button id="save-btn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50" disabled>
                    Save and Close
                </button>
            </div>
        </div>
    </div>

    <script>
        let selectedText = '';
        let originalText = '';
        let fieldType = '';

        // Listen for initialization from parent
        window.addEventListener('message', function(event) {
            if (event.origin !== window.location.origin) return;
            
            if (event.data.type === 'init_session') {
                initializeChat(event.data);
            }
        });

        function initializeChat(data) {
            console.log('ðŸŽ¯ Mock chat received init_session data:', data);
            
            originalText = data.currentText || '';
            fieldType = data.fieldType || '';
            
            console.log('ðŸ“‹ Context extracted:', { originalText, fieldType, teamName: data.teamName });
            
            // Update context info
            document.getElementById('context-info').textContent = 
                `Improving ${fieldType.replace('_', ' ')}: "${originalText}"`;

            // Add user message with original text
            if (originalText) {
                addMessage('user', `Please help me improve this ${fieldType.replace('_', ' ')}: "${originalText}"`);
                
                // Simulate AI response based on field type
                setTimeout(() => {
                    generateAIResponse(originalText, fieldType);
                }, 1000);
            } else {
                addMessage('user', `Help me write a good ${fieldType.replace('_', ' ')}`);
                setTimeout(() => {
                    generateAIResponse('', fieldType);
                }, 1000);
            }
        }

        function addMessage(sender, text) {
            const chatContainer = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-bubble ${sender}-message p-3 rounded-lg`;
            messageDiv.innerHTML = `<p class="text-sm">${text}</p>`;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function generateAIResponse(text, type) {
            let suggestions = [];
            
            if (type === 'activity_title') {
                if (text.toLowerCase().includes('homework')) {
                    suggestions = [
                        'Math Homework - Chapter 5 Algebra',
                        'Complete Mathematics Assignment (Algebra Basics)',
                        'Homework: Math Chapter 5 - Linear Equations'
                    ];
                } else if (text.toLowerCase().includes('meeting')) {
                    suggestions = [
                        'Team Standup Meeting - Sprint Planning',
                        'Weekly Team Meeting - Project Updates',
                        'Meeting: Project Status and Next Steps'
                    ];
                } else {
                    suggestions = [
                        'Implement User Authentication System',
                        'Fix Login Form Validation Bug',
                        'Research Database Optimization Techniques'
                    ];
                }
            } else if (type === 'activity_notes') {
                suggestions = [
                    'Completed initial research and documented findings in project wiki. Next: implement core functionality.',
                    'Made significant progress on the main feature. Tested edge cases and updated documentation.',
                    'Reviewed requirements with team, clarified scope, and updated task priorities for next sprint.'
                ];
            }

            let responseHtml = 'Here are some improved suggestions:<br><br>';
            suggestions.forEach((suggestion, index) => {
                responseHtml += `<span class="suggestion-button" onclick="selectSuggestion('${suggestion.replace(/'/g, '\\\'')}')">${suggestion}</span><br>`;
            });

            addAIMessage(responseHtml);
        }

        function addAIMessage(html) {
            const chatContainer = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-bubble ai-message p-3 rounded-lg';
            messageDiv.innerHTML = `<div class="text-sm">${html}</div>`;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function selectSuggestion(text) {
            selectedText = text;
            
            // Highlight the selected suggestion
            document.querySelectorAll('.suggestion-button').forEach(btn => {
                btn.style.background = '#e2e8f0';
                btn.style.color = '#334155';
            });
            event.target.style.background = '#3b82f6';
            event.target.style.color = 'white';
            
            // Enable save button
            document.getElementById('save-btn').disabled = false;
            
            // Add confirmation message
            addMessage('user', `I'll use: "${text}"`);
            setTimeout(() => {
                addAIMessage('Perfect! Click "Save and Close" to use this text, or select another option.');
            }, 500);
        }

        // Handle action buttons
        document.getElementById('save-btn').addEventListener('click', function() {
            // Send selected text back to parent
            window.parent.postMessage({
                type: 'text_selected',
                selectedText: selectedText,
                originalText: originalText,
                fieldType: fieldType
            }, window.location.origin);
        });

        document.getElementById('cancel-btn').addEventListener('click', function() {
            // Send cancel message to parent
            window.parent.postMessage({
                type: 'cancelled',
                originalText: originalText,
                fieldType: fieldType
            }, window.location.origin);
        });

        // Send ready message to parent
        window.parent.postMessage({
            type: 'chat_ready'
        }, window.location.origin);
    </script>
</body>
</html>